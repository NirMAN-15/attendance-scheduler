<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>Attendance Tracker - Fixed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #e3f2fd, #bbdefb); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .header h1 { color: #1976d2; margin-bottom: 5px; }
        .header p { color: #666; }
        .tabs { display: flex; gap: 10px; margin-top: 20px; }
        .tab { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; background: #e0e0e0; }
        .tab.active { background: #1976d2; color: white; }
        .content { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .date-section { margin-bottom: 20px; }
        .date-section input { width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .selected-info { margin-top: 10px; padding: 15px; background: #e3f2fd; border-radius: 5px; }
        .classes-grid { display: grid; gap: 15px; }
        .class-item { border: 1px solid #ddd; border-radius: 8px; padding: 15px; position: relative; }
        .class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .subject-code { background: #1976d2; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .class-type { padding: 3px 8px; border-radius: 3px; font-size: 11px; margin-left: 10px; }
        .lecture { background: #e8f5e8; color: #2e7d32; }
        .practical { background: #fff3e0; color: #ef6c00; }
        .tutorial { background: #f3e5f5; color: #7b1fa2; }
        .attendance-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-present { background: #4caf50; color: white; }
        .btn-absent { background: #f44336; color: white; }
        .btn-present.selected { background: #2e7d32; }
        .btn-absent.selected { background: #c62828; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .summary-card { background: #f5f5f5; padding: 20px; border-radius: 8px; }
        .percentage { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .good { color: #4caf50; }
        .warning { color: #ff9800; }
        .danger { color: #f44336; }
        .hidden { display: none; }
        .export-section { margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 8px; }
        .export-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-export { background: #1976d2; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-export:hover { background: #1565c0; }
        .holiday-section { margin: 20px 0; padding: 15px; background: #fff3e0; border-radius: 8px; }
        .holiday-input { display: flex; gap: 10px; align-items: center; margin: 10px 0; }
        .holiday-list { margin-top: 15px; }
        .holiday-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px; margin: 5px 0; }
        .btn-remove { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .btn-add { background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
        .settings-view { max-width: 800px; }
        .btn-undo { background: #ff9800; color: white; border: none; padding: 5px 12px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 5px; }
        .btn-undo:hover { background: #f57c00; }
        .footer { margin-top: 40px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .footer h4 { color: #1976d2; margin-bottom: 15px; }
        .contact-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; text-align: left; }
        .contact-item { background: #f5f5f5; padding: 15px; border-radius: 8px; }
        .contact-item strong { color: #1976d2; }
        .contact-item a { color: #1976d2; text-decoration: none; }
        .contact-item a:hover { text-decoration: underline; }
        .edit-section { margin: 20px 0; padding: 15px; background: #e8f5e8; border-radius: 8px; }
        .edit-input { display: flex; gap: 10px; align-items: center; margin: 10px 0; flex-wrap: wrap; }
        /* Modal */
        .modal { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 18px; border-radius: 8px; box-shadow: 0 6px 24px rgba(0,0,0,0.2); z-index: 9999; width: 320px; }
        .modal h4 { margin-bottom: 10px; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 9998; }
        .add-slot { margin-top: 15px; padding: 12px; background: #f5f5f5; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Attendance Tracker</h1>
            <p>National Diploma in Technology - Moratuwa</p>
            <div class="tabs">
                <button class="tab active" onclick="showView('daily', event)">Daily View</button>
                <button class="tab" onclick="showView('summary', event)">Summary</button>
                <button class="tab" onclick="showView('settings', event)">Settings</button>
            </div>
        </div>

        <div id="daily-view" class="content">
            <div class="date-section">
                <h3>üìÖ Select Date</h3>
                <input type="date" id="date-picker" onchange="updateDate()" />
                <div class="selected-info">
                    <strong>Selected Day: </strong><span id="selected-day">Monday</span><br>
                    <strong>Date: </strong><span id="selected-date">2025-08-11</span>
                </div>
            </div>
            
            <div>
                <h3 id="classes-title">üïí Classes for Monday</h3>
                <div id="classes-list" class="classes-grid">
                    <!-- Classes will be populated by JavaScript -->
                </div>

                <div class="add-slot">
                    <h4>Add or adjust class for selected date</h4>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                        <select id="add-time">
                            <option value="8.15am-9.15am">8:15 AM - 9:15 AM</option>
                            <option value="9.15am-10.15am">9:15 AM - 10:15 AM</option>
                            <option value="10.15am-11.15am">10:15 AM - 11:15 AM</option>
                            <option value="11.15am-12.15pm">11:15 AM - 12:15 PM</option>
                            <option value="1.15pm-2.15pm">1:15 PM - 2:15 PM</option>
                            <option value="2.15pm-3.15pm">2:15 PM - 3:15 PM</option>
                            <option value="3.15pm-4.15pm">3:15 PM - 4:15 PM</option>
                            <option value="4.15pm-5.15pm">4:15 PM - 5:15 PM</option>
                        </select>

                        <select id="add-subject"></select>

                        <select id="add-type">
                            <option value="L">Lecture</option>
                            <option value="P">Practical</option>
                            <option value="T">Tutorial</option>
                        </select>

                        <button class="btn-add" onclick="addSlotToDate()">Add/Update</button>
                    </div>
                    <p style="margin-top:8px;color:#666;font-size:13px;">Use this to add missing slots such as 3:15-5:15 for any day.</p>
                </div>
            </div>
        </div>

        <div id="summary-view" class="content hidden">
            <h3>üìä Attendance Summary</h3>
            
            <!-- Export Section -->
            <div class="export-section">
                <h4>üìÑ Export Attendance Report</h4>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportToPDF()">üìÑ Export as PDF</button>
                    <button class="btn-export" onclick="exportToText()">üìù Export as Text</button>
                    <button class="btn-export" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
                </div>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>Overall Attendance</h4>
                    <div id="overall-percentage" class="percentage good">0%</div>
                    <p>Total Classes: <span id="total-classes">0</span></p>
                    <p>Present: <span id="present-count">0</span></p>
                    <p>Absent: <span id="absent-count">0</span></p>
                    <p>Holidays Excluded: <span id="holiday-count">0</span></p>
                </div>
                
                <div class="summary-card">
                    <h4>Subject Breakdown</h4>
                    <div id="subject-breakdown"></div>
                </div>
            </div>
        </div>

        <div id="settings-view" class="content settings-view hidden">
            <h3>‚öôÔ∏è Settings</h3>
            
            <div class="holiday-section">
                <h4>üèñÔ∏è Holiday Management</h4>
                <p>Mark days as holidays to exclude them from attendance calculations.</p>
                
                <div class="holiday-input">
                    <input type="date" id="holiday-date" />
                    <input type="text" id="holiday-name" placeholder="Holiday name (optional)" />
                    <button class="btn-add" onclick="addHoliday()">Add Holiday</button>
                </div>
                
                <div class="holiday-list">
                    <h5>üìÖ Marked Holidays:</h5>
                    <div id="holidays-display"></div>
                </div>
            </div>

            <div class="edit-section">
                <h4>üìù Edit Schedule for Specific Dates</h4>
                <p>Use the daily view to edit. This section keeps date-wide edits and backups.</p>
                
                <div id="custom-schedule-display"></div>
            </div>

            <div class="export-section">
                <h4>üíæ Data Management</h4>
                <div class="export-buttons">
                    <button class="btn-export" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    <button class="btn-export" onclick="exportData()">üíæ Backup Data</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)" />
                    <button class="btn-export" onclick="document.getElementById('import-file').click()">üìÇ Import Data</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <h4>üë®‚Äçüíª Created by</h4>
            <div class="contact-info">
                <div class="contact-item">
                    <strong>Name:</strong><br>
                    W. Nirman Achintha
                </div>
                <div class="contact-item">
                    <strong>üì± Mobile:</strong><br>
                    <a href="tel:+94788597202">0788597202</a>
                </div>
                <div class="contact-item">
                    <strong>üìß Email:</strong><br>
                    <a href="mailto:nirmanachintha1313@gmail.com">nirmanachintha1313@gmail.com</a>
                </div>
                <div class="contact-item">
                    <strong>üíº LinkedIn:</strong><br>
                    <a href="https://www.linkedin.com/in/w-nirman-achintha/" target="_blank">W.Nirman Achintha | LinkedIn</a>
                </div>
                <div class="contact-item">
                    <strong>üíª GitHub:</strong><br>
                    <a href="https://github.com/NirMAN-15" target="_blank">github.com/NirMAN-15</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit modal -->
    <div id="overlay" class="hidden"></div>
    <div id="edit-modal" class="modal hidden" role="dialog" aria-hidden="true">
        <h4>Edit class for date</h4>
        <div><strong>Date:</strong> <span id="edit-modal-date-text"></span></div>
        <div><strong>Time:</strong> <span id="edit-modal-time"></span></div>
        <div style="margin-top:8px;">
            <select id="edit-modal-subject"></select>
            <select id="edit-modal-type" style="margin-left:8px;">
                <option value="L">Lecture</option>
                <option value="P">Practical</option>
                <option value="T">Tutorial</option>
            </select>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
            <button class="btn-undo" onclick="closeEditModal()">Cancel</button>
            <button class="btn-add" onclick="saveEditModal()">Save</button>
        </div>
    </div>

    <!-- jsPDF for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Original file reviewed: see uploaded file reference.
        // Subjects
        const subjects = {
            'IT1204': 'Fundamentals of Software Engineering',
            'IT1208': 'Web Technologies',
            'IS1203': 'English Language Skills Enhancement II',
            'IT1205': 'IT Security and Digital Forensics',
            'IS1204': 'Mathematical Methods with Engineering Applications',
            'IS1101': 'Aesthetic Studies',
            'IT1201': 'Computer Networks',
            'IT1203': 'Digital Electronics',
            'IT1206': 'Object Oriented Analysis and Design',
            'IT1207': 'Object Oriented Programming'
        };

        // Weekly schedule. Keep as default.
        const schedule = {
            'Monday': [
                { time: '8.15am-9.15am', subject: 'IT1204', type: 'L' },
                { time: '9.15am-10.15am', subject: 'IT1204', type: 'L' },
                { time: '10.15am-11.15am', subject: 'IS1101', type: 'P' }
            ],
            'Tuesday': [
                { time: '8.15am-9.15am', subject: 'IT1208', type: 'L' },
                { time: '9.15am-10.15am', subject: 'IT1208', type: 'L' },
                { time: '10.15am-11.15am', subject: 'IT1201', type: 'P' },
                { time: '11.15am-12.15pm', subject: 'IT1201', type: 'P' },
                { time: '1.15pm-2.15pm', subject: 'IT1206', type: 'L' },
                { time: '2.15pm-3.15pm', subject: 'IT1206', type: 'L' },
                { time: '3.15pm-4.15pm', subject: 'IT1206', type: 'L' }
            ],
            'Wednesday': [
                { time: '8.15am-9.15am', subject: 'IS1203', type: 'P' },
                { time: '9.15am-10.15am', subject: 'IS1203', type: 'P' },
                { time: '10.15am-11.15am', subject: 'IS1203', type: 'P' },
                { time: '11.15am-12.15pm', subject: 'IT1201', type: 'T' },
                { time: '1.15pm-2.15pm', subject: 'IT1207', type: 'P' },
                { time: '2.15pm-3.15pm', subject: 'IT1207', type: 'P' },
                { time: '3.15pm-4.15pm', subject: 'IT1207', type: 'P' }
            ],
            'Thursday': [
                { time: '8.15am-9.15am', subject: 'IT1205', type: 'T' },
                { time: '9.15am-10.15am', subject: 'IT1205', type: 'L' },
                { time: '10.15am-11.15am', subject: 'IT1205', type: 'P' },
                { time: '1.15pm-2.15pm', subject: 'IS1204', type: 'L' },
                { time: '2.15pm-3.15pm', subject: 'IS1204', type: 'L' },
                { time: '3.15pm-4.15pm', subject: 'IT1208', type: 'P' },
                { time: '4.15pm-5.15pm', subject: 'IT1208', type: 'P' }
            ],
            'Friday': [
                { time: '8.15am-9.15am', subject: 'IS1204', type: 'P' },
                { time: '9.15am-10.15am', subject: 'IS1204', type: 'P' },
                { time: '10.15am-11.15am', subject: 'IT1201', type: 'L' },
                { time: '11.15am-12.15pm', subject: 'IT1201', type: 'L' },
                { time: '1.15pm-2.15pm', subject: 'IT1203', type: 'L' },
                { time: '2.15pm-3.15pm', subject: 'IT1203', type: 'L' },
                { time: '3.15pm-4.15pm', subject: 'IT1203', type: 'T' },
                { time: '4.15pm-5.15pm', subject: 'IT1203', type: 'L' }
            ],
            'Saturday': [],
            'Sunday': []
        };

        // Attendance data
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData') || '{}');
        let holidays = JSON.parse(localStorage.getItem('holidays') || '{}');
        let customSchedule = JSON.parse(localStorage.getItem('customSchedule') || '{}');

        // Init
        const datePicker = document.getElementById('date-picker');
        datePicker.value = new Date().toISOString().split('T')[0];

        // Populate subject selects
        function populateSubjectSelects() {
            const addSub = document.getElementById('add-subject');
            const editSub = document.getElementById('edit-modal-subject');
            addSub.innerHTML = '';
            editSub.innerHTML = '';
            Object.keys(subjects).forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = code + ' - ' + subjects[code];
                addSub.appendChild(opt);
                const opt2 = opt.cloneNode(true);
                editSub.appendChild(opt2);
            });
        }

        populateSubjectSelects();
        updateDate();
        displayHolidays();
        displayCustomSchedule();

        function showView(view, evt) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.add('hidden'));
            if (evt && evt.target) evt.target.classList.add('active');
            document.getElementById(view + '-view').classList.remove('hidden');
            if (view === 'summary') updateSummary();
            if (view === 'settings') { displayHolidays(); displayCustomSchedule(); }
        }

        function getDayName(dateString) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[new Date(dateString).getDay()];
        }

        function updateDate() {
            const selectedDate = document.getElementById('date-picker').value;
            const dayName = getDayName(selectedDate);
            document.getElementById('selected-day').textContent = dayName;
            document.getElementById('selected-date').textContent = selectedDate;
            document.getElementById('classes-title').textContent = `üïí Classes for ${dayName}`;
            displayClasses(selectedDate, dayName);
        }

        function convertToMinutes(timeRange) {
            // Expect format like 8.15am-9.15am
            const startTime = timeRange.split('-')[0].trim();
            const parts = startTime.match(/(\d{1,2})(?:\.(\d{1,2}))?\s*([ap]m)/i);
            if (!parts) return 0;
            let hours = parseInt(parts[1], 10);
            const minutes = parseInt(parts[2] || '0', 10);
            const period = parts[3].toLowerCase();
            if (period === 'pm' && hours !== 12) hours += 12;
            if (period === 'am' && hours === 12) hours = 0;
            return hours * 60 + minutes;
        }

        function getMergedSchedule(date, day) {
            const defaults = schedule[day] || [];
            const custom = customSchedule[date] || [];
            // remove defaults that are overridden by custom (same time)
            const filtered = defaults.filter(d => !custom.some(c => c.time === d.time));
            const merged = filtered.concat(custom);
            merged.sort((a, b) => convertToMinutes(a.time) - convertToMinutes(b.time));
            return merged;
        }

        function displayClasses(date, day) {
            const classList = document.getElementById('classes-list');
            // holiday check
            if (holidays[date]) {
                classList.innerHTML = `<div class="class-item" style="background:#ffecb3;"><p>üèñÔ∏è Holiday: ${holidays[date]}</p><p>No classes scheduled</p></div>`;
                return;
            }
            const classes = getMergedSchedule(date, day);
            if (classes.length === 0) {
                classList.innerHTML = '<div class="class-item"><p>üìÖ No classes scheduled for this day</p></div>';
                return;
            }
            classList.innerHTML = classes.map((cls) => {
                const key = `${date}-${cls.subject}-${cls.time}`;
                const status = attendanceData[key];
                const typeClass = cls.type === 'L' ? 'lecture' : cls.type === 'P' ? 'practical' : 'tutorial';
                const typeName = cls.type === 'L' ? 'Lecture' : cls.type === 'P' ? 'Practical' : 'Tutorial';
                return `
                    <div class="class-item">
                        <div class="class-header">
                            <div>
                                <span class="subject-code">${cls.subject}</span>
                                <span class="class-type ${typeClass}">${typeName}</span>
                            </div>
                            <div style="display:flex;gap:8px;align-items:center;">
                                <button class="btn" onclick="openEditModal('${date}','${cls.time}','${cls.subject}','${cls.type}')">Edit</button>
                            </div>
                        </div>
                        <p><strong>${subjects[cls.subject] || cls.subject}</strong></p>
                        <p>‚è∞ ${cls.time}</p>
                        <div class="attendance-buttons">
                            <button class="btn btn-present ${status === 'present' ? 'selected' : ''}" onclick="markAttendance('${date}','${cls.time}','${cls.subject}','present')">‚úÖ Present</button>
                            <button class="btn btn-absent ${status === 'absent' ? 'selected' : ''}" onclick="markAttendance('${date}','${cls.time}','${cls.subject}','absent')">‚ùå Absent</button>
                            ${status ? `<button class="btn-undo" onclick="undoAttendance('${date}','${cls.time}','${cls.subject}')">‚Ü©Ô∏è Undo</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markAttendance(date, time, subject, status) {
            const key = `${date}-${subject}-${time}`;
            attendanceData[key] = status;
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            updateDate();
        }

        function undoAttendance(date, time, subject) {
            const key = `${date}-${subject}-${time}`;
            delete attendanceData[key];
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            updateDate();
        }

        function updateSummary() {
            const nonHolidayAttendance = {};
            Object.keys(attendanceData).forEach(key => {
                const date = key.split('-')[0];
                if (!holidays[date]) nonHolidayAttendance[key] = attendanceData[key];
            });
            const total = Object.keys(nonHolidayAttendance).length;
            const present = Object.values(nonHolidayAttendance).filter(s => s === 'present').length;
            const absent = Object.values(nonHolidayAttendance).filter(s => s === 'absent').length;
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
            const holidayCount = Object.keys(holidays).length;
            document.getElementById('total-classes').textContent = total;
            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
            document.getElementById('holiday-count').textContent = holidayCount;
            const percentageEl = document.getElementById('overall-percentage');
            percentageEl.textContent = percentage + '%';
            percentageEl.className = 'percentage ' + (percentage >= 75 ? 'good' : percentage >= 50 ? 'warning' : 'danger');
            const breakdown = document.getElementById('subject-breakdown');
            let subjectHtml = '';
            Object.keys(subjects).forEach(code => {
                const subjectEntries = Object.keys(nonHolidayAttendance).filter(key => key.includes(code));
                const subjectTotal = subjectEntries.length;
                const subjectPresent = subjectEntries.filter(key => nonHolidayAttendance[key] === 'present').length;
                const subjectPercentage = subjectTotal > 0 ? Math.round((subjectPresent / subjectTotal) * 100) : 0;
                const colorClass = subjectPercentage >= 75 ? 'good' : subjectPercentage >= 50 ? 'warning' : 'danger';
                if (subjectTotal > 0) {
                    subjectHtml += `<div style="margin: 10px 0; padding: 10px; border-left: 4px solid #1976d2;"><strong>${code}</strong><br><span class="${colorClass}">${subjectPercentage}%</span> (${subjectPresent}/${subjectTotal})</div>`;
                }
            });
            breakdown.innerHTML = subjectHtml || '<p>No attendance data yet</p>';
        }

        // Holiday functions
        function addHoliday() {
            const date = document.getElementById('holiday-date').value;
            const name = document.getElementById('holiday-name').value || 'Holiday';
            if (!date) { alert('Select a date'); return; }
            holidays[date] = name;
            localStorage.setItem('holidays', JSON.stringify(holidays));
            document.getElementById('holiday-date').value = '';
            document.getElementById('holiday-name').value = '';
            displayHolidays();
        }

        function removeHoliday(date) {
            delete holidays[date];
            localStorage.setItem('holidays', JSON.stringify(holidays));
            displayHolidays();
        }

        function displayHolidays() {
            const display = document.getElementById('holidays-display');
            const holidayDates = Object.keys(holidays).sort();
            if (holidayDates.length === 0) { display.innerHTML = '<p>No holidays marked</p>'; return; }
            display.innerHTML = holidayDates.map(date => {
                const dayName = getDayName(date);
                return `<div class="holiday-item"><span><strong>${holidays[date]}</strong> - ${date} (${dayName})</span><button class="btn-remove" onclick="removeHoliday('${date}')">Remove</button></div>`;
            }).join('');
        }

        // Export functions
        function generateAttendanceReport() {
            const nonHolidayAttendance = {};
            Object.keys(attendanceData).forEach(key => {
                const date = key.split('-')[0];
                if (!holidays[date]) nonHolidayAttendance[key] = attendanceData[key];
            });
            const total = Object.keys(nonHolidayAttendance).length;
            const present = Object.values(nonHolidayAttendance).filter(s => s === 'present').length;
            const absent = Object.values(nonHolidayAttendance).filter(s => s === 'absent').length;
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
            let report = `ATTENDANCE REPORT\n================================\nNational Diploma in Technology - Moratuwa\nGenerated on: ${new Date().toLocaleDateString()}\n\nOVERALL STATISTICS\n------------------\nTotal Classes (excluding holidays): ${total}\nPresent: ${present}\nAbsent: ${absent}\nOverall Attendance: ${percentage}%\nHolidays Excluded: ${Object.keys(holidays).length}\n\nSUBJECT-WISE BREAKDOWN\n----------------------\n`;
            Object.keys(subjects).forEach(code => {
                const subjectEntries = Object.keys(nonHolidayAttendance).filter(key => key.includes(code));
                const subjectTotal = subjectEntries.length;
                const subjectPresent = subjectEntries.filter(key => nonHolidayAttendance[key] === 'present').length;
                const subjectPercentage = subjectTotal > 0 ? Math.round((subjectPresent / subjectTotal) * 100) : 0;
                if (subjectTotal > 0) {
                    report += `${code}: ${subjectPercentage}% (${subjectPresent}/${subjectTotal}) - ${subjects[code]}\n`;
                }
            });
            if (Object.keys(holidays).length > 0) {
                report += `\nHOLIDAYS EXCLUDED\n-----------------\n`;
                Object.keys(holidays).sort().forEach(date => { report += `${date}: ${holidays[date]}\n`; });
            }
            return report;
        }

        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const report = generateAttendanceReport();
                const lines = report.split('\n');
                let y = 14;
                const lineHeight = 7;
                const pageHeight = doc.internal.pageSize.height - 20;
                lines.forEach(line => {
                    if (y > pageHeight) { doc.addPage(); y = 14; }
                    doc.text(line, 10, y);
                    y += lineHeight;
                });
                doc.save('attendance-report.pdf');
            } catch (e) {
                alert('PDF export failed. Use Export as Text or host the file online.');
            }
        }

        function exportToText() {
            const report = generateAttendanceReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'attendance-report.txt'; a.click(); URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            const report = generateAttendanceReport();
            navigator.clipboard.writeText(report).then(() => { alert('Attendance report copied to clipboard!'); }).catch(() => { const textarea = document.createElement('textarea'); textarea.value = report; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); alert('Attendance report copied to clipboard!'); });
        }

        // Data management
        function clearAllData() {
            if (!confirm('Clear all attendance data?')) return;
            localStorage.removeItem('attendanceData'); localStorage.removeItem('holidays'); localStorage.removeItem('customSchedule'); attendanceData = {}; holidays = {}; customSchedule = {}; updateDate(); displayHolidays(); alert('All data cleared');
        }

        function exportData() {
            const data = { attendanceData, holidays, customSchedule, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'attendance-backup.json'; a.click(); URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.attendanceData) attendanceData = data.attendanceData; if (data.holidays) holidays = data.holidays; if (data.customSchedule) customSchedule = data.customSchedule; localStorage.setItem('attendanceData', JSON.stringify(attendanceData)); localStorage.setItem('holidays', JSON.stringify(holidays)); localStorage.setItem('customSchedule', JSON.stringify(customSchedule)); updateDate(); displayHolidays(); displayCustomSchedule(); alert('Data imported'); } catch (err) { alert('Invalid file'); } }; reader.readAsText(file);
        }

        // Custom schedule functions
        function addSlotToDate() {
            const date = document.getElementById('date-picker').value;
            const time = document.getElementById('add-time').value;
            const subject = document.getElementById('add-subject').value;
            const type = document.getElementById('add-type').value;
            if (!date) { alert('Select date first'); return; }
            if (!customSchedule[date]) customSchedule[date] = [];
            // remove existing class at same time
            customSchedule[date] = customSchedule[date].filter(cls => cls.time !== time);
            customSchedule[date].push({ time, subject, type });
            customSchedule[date].sort((a, b) => convertToMinutes(a.time) - convertToMinutes(b.time));
            localStorage.setItem('customSchedule', JSON.stringify(customSchedule));
            displayCustomSchedule(); updateDate();
        }

        function displayCustomSchedule() {
            const display = document.getElementById('custom-schedule-display');
            const customDates = Object.keys(customSchedule).sort();
            if (customDates.length === 0) { display.innerHTML = '<p>No custom schedule changes</p>'; return; }
            display.innerHTML = `
                <h5>üìÖ Custom Schedule Changes:</h5>
                ${customDates.map(date => {
                    const dayName = getDayName(date);
                    return `<div class="holiday-item"><div><strong>${date} (${dayName})</strong><br>${customSchedule[date].map(cls => `${cls.time}: ${cls.subject} (${cls.type === 'L' ? 'Lecture' : cls.type === 'P' ? 'Practical' : 'Tutorial'})`).join('<br>')}</div><button class="btn-remove" onclick="removeCustomSchedule('${date}')">Remove</button></div>`;
                }).join('')}
            `;
        }

        function removeCustomSchedule(date) { delete customSchedule[date]; localStorage.setItem('customSchedule', JSON.stringify(customSchedule)); displayCustomSchedule(); updateDate(); }

        // Edit modal functions
        function openEditModal(date, time, subject, type) {
            document.getElementById('overlay').classList.remove('hidden');
            const modal = document.getElementById('edit-modal'); modal.classList.remove('hidden');
            document.getElementById('edit-modal-date-text').textContent = date;
            document.getElementById('edit-modal-time').textContent = time;
            document.getElementById('edit-modal-subject').value = subject || Object.keys(subjects)[0];
            document.getElementById('edit-modal-type').value = type || 'L';
            modal.dataset.date = date; modal.dataset.time = time;
        }

        function closeEditModal() { document.getElementById('overlay').classList.add('hidden'); document.getElementById('edit-modal').classList.add('hidden'); }

        function saveEditModal() {
            const modal = document.getElementById('edit-modal');
            const date = modal.dataset.date; const time = modal.dataset.time;
            const subject = document.getElementById('edit-modal-subject').value; const type = document.getElementById('edit-modal-type').value;
            if (!customSchedule[date]) customSchedule[date] = [];
            // remove any class at same time
            customSchedule[date] = customSchedule[date].filter(c => c.time !== time);
            customSchedule[date].push({ time, subject, type });
            customSchedule[date].sort((a, b) => convertToMinutes(a.time) - convertToMinutes(b.time));
            localStorage.setItem('customSchedule', JSON.stringify(customSchedule));
            closeEditModal(); displayCustomSchedule(); updateDate();
        }

        // initial populate for edit modal subject select
        // already done in populateSubjectSelects

    </script>
</body>
</html>
