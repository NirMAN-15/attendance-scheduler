<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>Attendance Tracker - Enhanced</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 10px; 
            transition: all 0.3s ease;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            margin-bottom: 15px; 
            animation: slideInFromTop 0.6s ease-out;
        }
        .header h1 { 
            color: #1976d2; 
            margin-bottom: 5px; 
            font-size: 1.8em;
            background: linear-gradient(45deg, #1976d2, #42a5f5);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header p { color: #666; font-size: 1em; }
        
        .tabs { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px; 
            margin-top: 20px; 
            background: rgba(0,0,0,0.05);
            padding: 8px;
            border-radius: 15px;
        }
        .tab { 
            padding: 12px 8px; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            background: transparent;
            color: #666;
            font-weight: 500;
            font-size: 0.9em;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .tab:hover::before { left: 100%; }
        .tab.active { 
            background: linear-gradient(45deg, #1976d2, #42a5f5); 
            color: white; 
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(25,118,210,0.3);
        }
        
        .content { 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            animation: fadeInUp 0.5s ease-out;
        }
        
        .date-section { margin-bottom: 25px; }
        .date-section h3 { color: #1976d2; margin-bottom: 15px; font-size: 1.2em; }
        .date-section input { 
            width: 100%; 
            max-width: 250px;
            padding: 12px 16px; 
            border: 2px solid #e0e0e0; 
            border-radius: 12px; 
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .date-section input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25,118,210,0.1);
            transform: translateY(-1px);
        }
        
        .selected-info { 
            margin-top: 15px; 
            padding: 15px; 
            background: linear-gradient(45deg, #e3f2fd, #f3e5f5); 
            border-radius: 15px;
            border-left: 5px solid #1976d2;
            animation: slideInFromLeft 0.5s ease-out;
            font-size: 0.95em;
        }
        
        .classes-grid { 
            display: flex;
            flex-direction: column;
            gap: 15px; 
            animation: staggerIn 0.6s ease-out;
        }
        .class-item { 
            border: 2px solid #e0e0e0; 
            border-radius: 16px; 
            padding: 18px; 
            position: relative; 
            background: rgba(255,255,255,0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .class-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(25,118,210,0.05), transparent);
            transition: left 0.6s;
        }
        .class-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #1976d2;
        }
        .class-item:hover::before { left: 100%; }
        
        .class-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 12px; 
            flex-wrap: wrap;
            gap: 10px;
        }
        .subject-info {
            flex: 1;
            min-width: 200px;
        }
        .subject-code { 
            background: linear-gradient(45deg, #1976d2, #42a5f5); 
            color: white; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(25,118,210,0.3);
            display: inline-block;
            margin-bottom: 8px;
        }
        .class-type { 
            padding: 4px 10px; 
            border-radius: 15px; 
            font-size: 11px; 
            margin-left: 8px;
            font-weight: 600;
            display: inline-block;
        }
        .lecture { background: linear-gradient(45deg, #e8f5e8, #c8e6c9); color: #2e7d32; }
        .practical { background: linear-gradient(45deg, #fff3e0, #ffe0b2); color: #ef6c00; }
        .tutorial { background: linear-gradient(45deg, #f3e5f5, #e1bee7); color: #7b1fa2; }
        
        .class-title {
            font-weight: 600;
            margin: 8px 0;
            font-size: 0.95em;
            line-height: 1.3;
        }
        .class-time {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 12px;
        }
        
        .attendance-buttons { 
            display: flex; 
            gap: 8px; 
            margin-top: 15px; 
            animation: slideInFromBottom 0.4s ease-out;
            flex-wrap: wrap;
        }
        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer; 
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            flex: 1;
            min-width: 80px;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.3s ease;
            transform: translate(-50%, -50%);
        }
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        .btn-present { background: linear-gradient(45deg, #4caf50, #66bb6a); color: white; }
        .btn-absent { background: linear-gradient(45deg, #f44336, #ef5350); color: white; }
        .btn-present:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76,175,80,0.3); }
        .btn-absent:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(244,67,54,0.3); }
        .btn-present.selected { background: linear-gradient(45deg, #2e7d32, #388e3c); transform: scale(1.05); }
        .btn-absent.selected { background: linear-gradient(45deg, #c62828, #d32f2f); transform: scale(1.05); }
        
        .summary-grid { 
            display: flex;
            flex-direction: column;
            gap: 20px; 
        }
        .summary-card { 
            background: linear-gradient(45deg, #f8f9fa, #ffffff); 
            padding: 20px; 
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .summary-card:hover {
            transform: translateY(-3px);
            border-color: #1976d2;
        }
        .percentage { 
            font-size: 2.2em; 
            font-weight: 700; 
            margin: 12px 0;
            background: linear-gradient(45deg, #1976d2, #42a5f5);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .good { background: linear-gradient(45deg, #4caf50, #66bb6a) !important; -webkit-text-fill-color: transparent; }
        .warning { background: linear-gradient(45deg, #ff9800, #ffb74d) !important; -webkit-text-fill-color: transparent; }
        .danger { background: linear-gradient(45deg, #f44336, #ef5350) !important; -webkit-text-fill-color: transparent; }
        
        .hidden { display: none; }
        
        .export-section, .holiday-section, .edit-section, .timetable-section { 
            margin: 20px 0; 
            padding: 18px; 
            background: linear-gradient(45deg, #f0f8ff, #e6f3ff); 
            border-radius: 16px;
            border: 2px solid rgba(25,118,210,0.1);
            animation: fadeInUp 0.5s ease-out;
        }
        .timetable-section { background: linear-gradient(45deg, #e8f5e8, #f1f8e9); }
        
        .export-buttons, .timetable-actions { 
            display: flex; 
            gap: 10px; 
            flex-direction: column;
            margin-top: 15px;
        }
        .btn-export, .btn-timetable { 
            background: linear-gradient(45deg, #1976d2, #42a5f5); 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-align: center;
        }
        .btn-export:hover, .btn-timetable:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(25,118,210,0.3);
        }
        .btn-export:active, .btn-timetable:active { transform: translateY(-1px); }
        
        .holiday-input, .edit-input { 
            display: flex; 
            flex-direction: column;
            gap: 12px; 
            margin: 15px 0; 
        }
        .holiday-list { margin-top: 20px; }
        .holiday-item, .timetable-item { 
            display: flex; 
            flex-direction: column;
            gap: 10px;
            padding: 15px; 
            background: rgba(255,255,255,0.9); 
            border-radius: 12px; 
            margin: 8px 0;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            animation: slideInFromRight 0.4s ease-out;
        }
        .holiday-item:hover, .timetable-item:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
        }
        
        .item-content {
            flex: 1;
        }
        .item-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }
        
        .btn-remove, .btn-edit-time { 
            background: linear-gradient(45deg, #f44336, #ef5350); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-edit-time { background: linear-gradient(45deg, #ff9800, #ffb74d); }
        .btn-remove:hover, .btn-edit-time:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 15px rgba(244,67,54,0.3); 
        }
        
        .btn-add { 
            background: linear-gradient(45deg, #4caf50, #66bb6a); 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 25px; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn-add:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(76,175,80,0.3);
        }
        
        .settings-view { max-width: 100%; }
        .btn-undo { 
            background: linear-gradient(45deg, #ff9800, #ffb74d); 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 12px; 
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-undo:hover { 
            transform: scale(1.05); 
            box-shadow: 0 4px 15px rgba(255,152,0,0.3);
        }
        
        .footer { 
            margin-top: 30px; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
            text-align: center;
            animation: slideInFromBottom 0.6s ease-out;
        }
        .footer h4 { color: #1976d2; margin-bottom: 20px; font-size: 1.2em; }
        .contact-info { 
            display: flex;
            flex-direction: column;
            gap: 15px; 
            text-align: left; 
        }
        .contact-item { 
            background: linear-gradient(45deg, #f5f5f5, #fafafa); 
            padding: 15px; 
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .contact-item:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
        }
        .contact-item strong { color: #1976d2; }
        .contact-item a { color: #1976d2; text-decoration: none; transition: color 0.3s ease; }
        .contact-item a:hover { color: #0d47a1; text-decoration: underline; }
        
        /* Modal - Mobile Optimized */
        .modal { 
            position: fixed; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%) scale(0.8); 
            background: white; 
            padding: 20px; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            z-index: 9999; 
            width: 95%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.show { 
            transform: translate(-50%, -50%) scale(1); 
            opacity: 1;
        }
        .modal h4 { margin-bottom: 15px; color: #1976d2; font-size: 1.1em; }
        .overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.6); 
            z-index: 9998; 
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .overlay.show { opacity: 1; }
        
        .add-slot { 
            margin-top: 20px; 
            padding: 18px; 
            background: linear-gradient(45deg, #f5f5f5, #fafafa); 
            border-radius: 16px;
            border: 2px solid rgba(25,118,210,0.1);
            transition: all 0.3s ease;
        }
        .add-slot:hover {
            border-color: rgba(25,118,210,0.3);
        }
        .add-slot h4 {
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        /* Timetable specific styles - Mobile Optimized */
        .timetable-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .day-schedule {
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 18px;
            border: 2px solid rgba(25,118,210,0.1);
            transition: all 0.3s ease;
        }
        .day-schedule:hover {
            border-color: #1976d2;
            transform: translateY(-2px);
        }
        .day-title {
            color: #1976d2;
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .time-slot {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .time-slot:hover {
            background: #e3f2fd;
            border-color: #1976d2;
        }
        .time-slot-info {
            flex: 1;
        }
        .time-slot-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 12px 0;
        }
        .form-row input, .form-row select {
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-size: 16px; /* Prevents zoom on iOS */
            width: 100%;
        }
        .form-row input:focus, .form-row select:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25,118,210,0.1);
        }
        
        /* Modal form rows for better mobile experience */
        .modal .form-row {
            gap: 10px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-direction: column;
        }
        .modal-actions button {
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* Edit button in class header - Mobile optimized */
        .edit-button {
            background: linear-gradient(45deg, #ff9800, #ffb74d);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .edit-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(255,152,0,0.3);
        }
        
        /* Animations */
        @keyframes slideInFromTop {
            0% { transform: translateY(-30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideInFromBottom {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideInFromLeft {
            0% { transform: translateX(-20px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInFromRight {
            0% { transform: translateX(20px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeInUp {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes staggerIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .success-animation {
            animation: pulse 0.6s ease-in-out;
        }
        
        /* Success message - Mobile optimized */
        .success-message {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 15px;
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            font-weight: 600;
            z-index: 10000;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
            box-shadow: 0 8px 32px rgba(76,175,80,0.3);
            text-align: center;
        }
        .success-message.show {
            transform: translateY(0);
        }
        
        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            body { padding: 5px; }
            
            .header { 
                padding: 15px; 
                margin-bottom: 10px;
            }
            .header h1 { font-size: 1.6em; }
            
            .content { padding: 15px; }
            
            .tabs { 
                gap: 5px;
                padding: 5px;
            }
            .tab { 
                padding: 10px 6px;
                font-size: 0.85em;
            }
            
            .class-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .subject-info {
                width: 100%;
                min-width: auto;
            }
            .subject-code {
                font-size: 11px;
                padding: 5px 10px;
            }
            .class-type {
                font-size: 10px;
                padding: 3px 8px;
                margin-left: 6px;
            }
            
            .attendance-buttons {
                gap: 6px;
            }
            .btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 70px;
            }
            
            .btn-undo {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .edit-button {
                padding: 5px 10px;
                font-size: 10px;
            }
            
            .percentage { font-size: 2em; }
            
            .export-buttons, .timetable-actions {
                gap: 8px;
            }
            
            .modal { 
                width: 95%; 
                max-width: 350px; 
                padding: 18px;
                margin: 10px;
            }
            
            .time-slot {
                padding: 10px;
            }
            .time-slot-actions {
                gap: 6px;
            }
            
            .holiday-item, .timetable-item {
                padding: 12px;
            }
            
            .contact-info {
                gap: 12px;
            }
            .contact-item {
                padding: 12px;
            }
            
            .footer {
                padding: 15px;
                margin-top: 20px;
            }
            
            /* Better touch targets */
            .btn, .btn-export, .btn-timetable, .btn-add, .btn-remove, .btn-edit-time, .btn-undo {
                min-height: 44px; /* Apple's recommended minimum touch target */
            }
            
            /* Improved form elements for mobile */
            .form-row input, .form-row select {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Better spacing for mobile */
            .date-section, .holiday-section, .edit-section, .timetable-section {
                margin: 15px 0;
                padding: 15px;
            }
            
            .selected-info {
                padding: 12px;
                font-size: 0.9em;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .header h1 { font-size: 1.4em; }
            .header p { font-size: 0.9em; }
            
            .tab { 
                padding: 8px 4px;
                font-size: 0.8em;
            }
            
            .subject-code {
                font-size: 10px;
                padding: 4px 8px;
            }
            .class-type {
                font-size: 9px;
                padding: 2px 6px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 60px;
            }
            
            .percentage { font-size: 1.8em; }
            
            .modal {
                padding: 15px;
            }
            
            .success-message {
                padding: 12px 15px;
                font-size: 0.9em;
            }
        }
        
        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .summary-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .export-buttons, .timetable-actions {
                flex-direction: row;
                flex-wrap: wrap;
            }
            .btn-export, .btn-timetable {
                flex: 1;
                min-width: 140px;
            }
        }
        
        /* Better focus indicators for accessibility */
        .btn:focus, .tab:focus, input:focus, select:focus {
            outline: 3px solid rgba(25,118,210,0.5);
            outline-offset: 2px;
        }
        
        /* Prevent text selection on buttons */
        .btn, .tab, .btn-export, .btn-timetable, .btn-add, .btn-remove, .btn-edit-time, .btn-undo {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Loading state styles */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        /* Better mobile scrolling */
        .modal {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📚 Attendance Tracker</h1>
            <p>National Diploma in Technology - Moratuwa</p>
            <div class="tabs">
                <button class="tab active" onclick="showView('daily', event)">📅 Daily</button>
                <button class="tab" onclick="showView('summary', event)">📊 Summary</button>
                <button class="tab" onclick="showView('settings', event)">⚙️ Settings</button>
            </div>
        </div>

        <div id="daily-view" class="content">
            <div class="date-section">
                <h3>📅 Select Date</h3>
                <input type="date" id="date-picker" onchange="updateDate()" />
                <div class="selected-info">
                    <strong>Selected Day: </strong><span id="selected-day">Monday</span><br>
                    <strong>Date: </strong><span id="selected-date">2025-08-11</span>
                </div>
            </div>
            
            <div>
                <h3 id="classes-title">🕐 Classes for Monday</h3>
                <div id="classes-list" class="classes-grid">
                    <!-- Classes will be populated by JavaScript -->
                </div>

                <div class="add-slot">
                    <h4>📝 Add or adjust class for selected date</h4>
                    <div class="form-row">
                        <select id="add-time">
                            <option value="8.15am-9.15am">8:15 AM - 9:15 AM</option>
                            <option value="9.15am-10.15am">9:15 AM - 10:15 AM</option>
                            <option value="10.15am-11.15am">10:15 AM - 11:15 AM</option>
                            <option value="11.15am-12.15pm">11:15 AM - 12:15 PM</option>
                            <option value="1.15pm-2.15pm">1:15 PM - 2:15 PM</option>
                            <option value="2.15pm-3.15pm">2:15 PM - 3:15 PM</option>
                            <option value="3.15pm-4.15pm">3:15 PM - 4:15 PM</option>
                            <option value="4.15pm-5.15pm">4:15 PM - 5:15 PM</option>
                        </select>
                        <select id="add-subject"></select>
                        <select id="add-type">
                            <option value="L">Lecture</option>
                            <option value="P">Practical</option>
                            <option value="T">Tutorial</option>
                        </select>
                        <button class="btn-add" onclick="addSlotToDate()">✅ Add/Update</button>
                    </div>
                    <p style="margin-top:12px;color:#666;font-size:14px;">💡 Use this to add missing slots or modify existing classes for the selected date.</p>
                </div>
            </div>
        </div>

        <div id="summary-view" class="content hidden">
            <h3>📊 Attendance Summary</h3>
            
            <!-- Export Section -->
            <div class="export-section">
                <h4>📄 Export Attendance Report</h4>
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportToPDF()">📄 Export as PDF</button>
                    <button class="btn-export" onclick="exportToText()">📝 Export as Text</button>
                    <button class="btn-export" onclick="copyToClipboard()">📋 Copy to Clipboard</button>
                </div>
            </div>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <h4>📈 Overall Attendance</h4>
                    <div id="overall-percentage" class="percentage good">0%</div>
                    <p><strong>Total Classes:</strong> <span id="total-classes">0</span></p>
                    <p><strong>Present:</strong> <span id="present-count">0</span></p>
                    <p><strong>Absent:</strong> <span id="absent-count">0</span></p>
                    <p><strong>Holidays Excluded:</strong> <span id="holiday-count">0</span></p>
                </div>
                
                <div class="summary-card">
                    <h4>📚 Subject Breakdown</h4>
                    <div id="subject-breakdown"></div>
                </div>
            </div>
        </div>

        <div id="settings-view" class="content settings-view hidden">
            <h3>⚙️ Settings & Configuration</h3>
            
            <!-- Timetable Management Section -->
            <div class="timetable-section">
                <h4>📅 Timetable Management</h4>
                <p>Manage your weekly class schedule. Changes here will be your default timetable.</p>
                
                <div class="form-row">
                    <select id="timetable-day">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                    <select id="timetable-time">
                        <option value="8.15am-9.15am">8:15 AM - 9:15 AM</option>
                        <option value="9.15am-10.15am">9:15 AM - 10:15 AM</option>
                        <option value="10.15am-11.15am">10:15 AM - 11:15 AM</option>
                        <option value="11.15am-12.15pm">11:15 AM - 12:15 PM</option>
                        <option value="1.15pm-2.15pm">1:15 PM - 2:15 PM</option>
                        <option value="2.15pm-3.15pm">2:15 PM - 3:15 PM</option>
                        <option value="3.15pm-4.15pm">3:15 PM - 4:15 PM</option>
                        <option value="4.15pm-5.15pm">4:15 PM - 5:15 PM</option>
                    </select>
                    <select id="timetable-subject"></select>
                    <select id="timetable-type">
                        <option value="L">Lecture</option>
                        <option value="P">Practical</option>
                        <option value="T">Tutorial</option>
                    </select>
                </div>
                
                <div class="timetable-actions">
                    <button class="btn-timetable" onclick="addToTimetable()">➕ Add to Timetable</button>
                    <button class="btn-timetable" onclick="resetTimetable()" style="background: linear-gradient(45deg, #f44336, #ef5350);">🔄 Reset to Default</button>
                </div>
                
                <div class="timetable-grid" id="timetable-display">
                    <!-- Timetable will be displayed here -->
                </div>
            </div>
            
            <div class="holiday-section">
                <h4>🖤 Holiday Management</h4>
                <p>Mark days as holidays to exclude them from attendance calculations.</p>
                
                <div class="holiday-input">
                    <input type="date" id="holiday-date" />
                    <input type="text" id="holiday-name" placeholder="Holiday name (optional)" />
                    <button class="btn-add" onclick="addHoliday()">🎉 Add Holiday</button>
                </div>
                
                <div class="holiday-list">
                    <h5>📅 Marked Holidays:</h5>
                    <div id="holidays-display"></div>
                </div>
            </div>

            <div class="edit-section">
                <h4>📝 Custom Schedule Changes</h4>
                <p>View and manage date-specific schedule modifications. Use the daily view to make changes.</p>
                
                <div id="custom-schedule-display"></div>
            </div>

            <div class="export-section">
                <h4>💾 Data Management</h4>
                <div class="export-buttons">
                    <button class="btn-export" onclick="clearAllData()" style="background: linear-gradient(45d, #f44336, #ef5350);">🗑️ Clear All Data</button>
                    <button class="btn-export" onclick="exportData()">💾 Backup Data</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)" />
                    <button class="btn-export" onclick="document.getElementById('import-file').click()">📂 Import Data</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <h4>👨‍💻 Created by</h4>
            <div class="contact-info">
                <div class="contact-item">
                    <strong>Name:</strong><br>
                    W. Nirman Achintha
                </div>
                <div class="contact-item">
                    <strong>📱 Mobile:</strong><br>
                    <a href="tel:+94788597202">0788597202</a>
                </div>
                <div class="contact-item">
                    <strong>📧 Email:</strong><br>
                    <a href="mailto:nirmanachintha1313@gmail.com">nirmanachintha1313@gmail.com</a>
                </div>
                <div class="contact-item">
                    <strong>💼 LinkedIn:</strong><br>
                    <a href="https://www.linkedin.com/in/w-nirman-achintha/" target="_blank">W.Nirman Achintha</a>
                </div>
                <div class="contact-item">
                    <strong>💻 GitHub:</strong><br>
                    <a href="https://github.com/NirMAN-15" target="_blank">github.com/NirMAN-15</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit modal -->
    <div id="overlay" class="overlay hidden" onclick="closeEditModal()"></div>
    <div id="edit-modal" class="modal hidden" role="dialog" aria-hidden="true">
        <h4>✏️ Edit Class</h4>
        <div><strong>Date:</strong> <span id="edit-modal-date-text"></span></div>
        <div><strong>Time:</strong> <span id="edit-modal-time"></span></div>
        <div class="form-row" style="margin-top:15px;">
            <select id="edit-modal-subject"></select>
            <select id="edit-modal-type">
                <option value="L">Lecture</option>
                <option value="P">Practical</option>
                <option value="T">Tutorial</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn-add" onclick="saveEditModal()">💾 Save</button>
            <button class="btn-undo" onclick="closeEditModal()">❌ Cancel</button>
        </div>
    </div>

    <!-- Timetable Edit Modal -->
    <div id="timetable-edit-modal" class="modal hidden" role="dialog" aria-hidden="true">
        <h4>📚 Edit Timetable Slot</h4>
        <div><strong>Day:</strong> <span id="tt-edit-day"></span></div>
        <div><strong>Time:</strong> <span id="tt-edit-time"></span></div>
        <div class="form-row" style="margin-top:15px;">
            <select id="tt-edit-subject"></select>
            <select id="tt-edit-type">
                <option value="L">Lecture</option>
                <option value="P">Practical</option>
                <option value="T">Tutorial</option>
            </select>
        </div>
        <div class="modal-actions">
            <button class="btn-add" onclick="saveTimetableEdit()">💾 Save</button>
            <button class="btn-remove" onclick="removeTimetableSlot()">🗑️ Remove</button>
            <button class="btn-undo" onclick="closeTimetableEditModal()">❌ Cancel</button>
        </div>
    </div>

    <!-- Success Message -->
    <div id="success-message" class="success-message hidden">
        <span id="success-text">✅ Success!</span>
    </div>

    <!-- jsPDF for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Subjects
        const subjects = {
            'IT1204': 'Fundamentals of Software Engineering',
            'IT1208': 'Web Technologies',
            'IS1203': 'English Language Skills Enhancement II',
            'IT1205': 'IT Security and Digital Forensics',
            'IS1204': 'Mathematical Methods with Engineering Applications',
            'IS1101': 'Aesthetic Studies',
            'IT1201': 'Computer Networks',
            'IT1203': 'Digital Electronics',
            'IT1206': 'Object Oriented Analysis and Design',
            'IT1207': 'Object Oriented Programming'
        };

        // Default weekly schedule
        const defaultSchedule = {
            'Monday': [
                { time: '8.15am-9.15am', subject: 'IT1204', type: 'L' },
                { time: '9.15am-10.15am', subject: 'IT1204', type: 'L' },
                { time: '10.15am-11.15am', subject: 'IS1101', type: 'P' }
            ],
            'Tuesday': [
                { time: '8.15am-9.15am', subject: 'IT1208', type: 'L' },
                { time: '9.15am-10.15am', subject: 'IT1208', type: 'L' },
                { time: '10.15am-11.15am', subject: 'IT1201', type: 'P' },
                { time: '11.15am-12.15pm', subject: 'IT1201', type: 'P' },
                { time: '1.15pm-2.15pm', subject: 'IT1206', type: 'L' },
                { time: '2.15pm-3.15pm', subject: 'IT1206', type: 'L' },
                { time: '3.15pm-4.15pm', subject: 'IT1206', type: 'L' }
            ],
            'Wednesday': [
                { time: '8.15am-9.15am', subject: 'IS1203', type: 'P' },
                { time: '9.15am-10.15am', subject: 'IS1203', type: 'P' },
                { time: '10.15am-11.15am', subject: 'IS1203', type: 'P' },
                { time: '11.15am-12.15pm', subject: 'IT1201', type: 'T' },
                { time: '1.15pm-2.15pm', subject: 'IT1207', type: 'P' },
                { time: '2.15pm-3.15pm', subject: 'IT1207', type: 'P' },
                { time: '3.15pm-4.15pm', subject: 'IT1207', type: 'P' }
            ],
            'Thursday': [
                { time: '8.15am-9.15am', subject: 'IT1205', type: 'T' },
                { time: '9.15am-10.15am', subject: 'IT1205', type: 'L' },
                { time: '10.15am-11.15am', subject: 'IT1205', type: 'P' },
                { time: '1.15pm-2.15pm', subject: 'IS1204', type: 'L' },
                { time: '2.15pm-3.15pm', subject: 'IS1204', type: 'L' },
                { time: '3.15pm-4.15pm', subject: 'IT1208', type: 'P' },
                { time: '4.15pm-5.15pm', subject: 'IT1208', type: 'P' }
            ],
            'Friday': [
                { time: '8.15am-9.15am', subject: 'IS1204', type: 'P' },
                { time: '9.15am-10.15am', subject: 'IS1204', type: 'P' },
                { time: '10.15am-11.15am', subject: 'IT1201', type: 'L' },
                { time: '11.15am-12.15pm', subject: 'IT1201', type: 'L' },
                { time: '1.15pm-2.15pm', subject: 'IT1203', type: 'L' },
                { time: '2.15pm-3.15pm', subject: 'IT1203', type: 'L' },
                { time: '3.15pm-4.15pm', subject: 'IT1203', type: 'T' },
                { time: '4.15pm-5.15pm', subject: 'IT1203', type: 'L' }
            ],
            'Saturday': [],
            'Sunday': []
        };

        // Initialize storage with fallback for environments without localStorage
        function getStorageItem(key, defaultValue = null) {
            try {
                return JSON.parse(localStorage.getItem(key)) || defaultValue;
            } catch (e) {
                return defaultValue;
            }
        }

        function setStorageItem(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.warn('Storage not available, using memory only');
            }
        }

        // Current schedule (can be modified)
        let schedule = getStorageItem('schedule') || JSON.parse(JSON.stringify(defaultSchedule));

        // Attendance data
        let attendanceData = getStorageItem('attendanceData') || {};
        let holidays = getStorageItem('holidays') || {};
        let customSchedule = getStorageItem('customSchedule') || {};

        // Init
        const datePicker = document.getElementById('date-picker');
        datePicker.value = new Date().toISOString().split('T')[0];

        // Populate subject selects
        function populateSubjectSelects() {
            const selects = ['add-subject', 'edit-modal-subject', 'timetable-subject', 'tt-edit-subject'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '';
                    Object.keys(subjects).forEach(code => {
                        const opt = document.createElement('option');
                        opt.value = code;
                        opt.textContent = code + ' - ' + subjects[code];
                        select.appendChild(opt);
                    });
                }
            });
        }

        // Animation utilities
        function showSuccessMessage(text) {
            const msg = document.getElementById('success-message');
            const textEl = document.getElementById('success-text');
            textEl.textContent = text;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('show'), 10);
            setTimeout(() => {
                msg.classList.remove('show');
                setTimeout(() => msg.classList.add('hidden'), 300);
            }, 3000);
        }

        function animateElement(element, animationClass) {
            element.classList.add(animationClass);
            setTimeout(() => element.classList.remove(animationClass), 600);
        }

        // Initialize
        populateSubjectSelects();
        updateDate();
        displayHolidays();
        displayCustomSchedule();
        displayTimetable();

        function showView(view, evt) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.add('hidden'));
            if (evt && evt.target) {
                evt.target.classList.add('active');
                animateElement(evt.target, 'success-animation');
            }
            const viewElement = document.getElementById(view + '-view');
            viewElement.classList.remove('hidden');
            
            // Add stagger animation to content
            setTimeout(() => {
                if (view === 'summary') updateSummary();
                if (view === 'settings') { 
                    displayHolidays(); 
                    displayCustomSchedule(); 
                    displayTimetable();
                }
            }, 100);
        }

        function getDayName(dateString) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[new Date(dateString).getDay()];
        }

        function updateDate() {
            const selectedDate = document.getElementById('date-picker').value;
            const dayName = getDayName(selectedDate);
            document.getElementById('selected-day').textContent = dayName;
            document.getElementById('selected-date').textContent = selectedDate;
            document.getElementById('classes-title').textContent = `🕐 Classes for ${dayName}`;
            displayClasses(selectedDate, dayName);
        }

        function convertToMinutes(timeRange) {
            const startTime = timeRange.split('-')[0].trim();
            const parts = startTime.match(/(\d{1,2})(?:\.(\d{1,2}))?\s*([ap]m)/i);
            if (!parts) return 0;
            let hours = parseInt(parts[1], 10);
            const minutes = parseInt(parts[2] || '0', 10);
            const period = parts[3].toLowerCase();
            if (period === 'pm' && hours !== 12) hours += 12;
            if (period === 'am' && hours === 12) hours = 0;
            return hours * 60 + minutes;
        }

        function getMergedSchedule(date, day) {
            const defaults = schedule[day] || [];
            const custom = customSchedule[date] || [];
            const filtered = defaults.filter(d => !custom.some(c => c.time === d.time));
            const merged = filtered.concat(custom);
            merged.sort((a, b) => convertToMinutes(a.time) - convertToMinutes(b.time));
            return merged;
        }

        function displayClasses(date, day) {
            const classList = document.getElementById('classes-list');
            
            if (holidays[date]) {
                classList.innerHTML = `
                    <div class="class-item" style="background:linear-gradient(45deg, #ffecb3, #fff8e1);border-color:#ff9800;">
                        <p style="font-size:1.1em;">🖤 Holiday: ${holidays[date]}</p>
                        <p style="color:#666;margin-top:8px;">No classes scheduled</p>
                    </div>`;
                return;
            }
            
            const classes = getMergedSchedule(date, day);
            if (classes.length === 0) {
                classList.innerHTML = `
                    <div class="class-item" style="background:linear-gradient(45deg, #f5f5f5, #fafafa);">
                        <p style="font-size:1.1em;">📅 No classes scheduled for this day</p>
                        <p style="color:#666;margin-top:8px;">Enjoy your free day!</p>
                    </div>`;
                return;
            }
            
            classList.innerHTML = classes.map((cls, index) => {
                const key = `${date}-${cls.subject}-${cls.time}`;
                const status = attendanceData[key];
                const typeClass = cls.type === 'L' ? 'lecture' : cls.type === 'P' ? 'practical' : 'tutorial';
                const typeName = cls.type === 'L' ? 'Lecture' : cls.type === 'P' ? 'Practical' : 'Tutorial';
                
                return `
                    <div class="class-item" style="animation-delay: ${index * 0.1}s;">
                        <div class="class-header">
                            <div class="subject-info">
                                <div>
                                    <span class="subject-code">${cls.subject}</span>
                                    <span class="class-type ${typeClass}">${typeName}</span>
                                </div>
                                <div class="class-title">${subjects[cls.subject] || cls.subject}</div>
                                <div class="class-time">⏰ ${cls.time}</div>
                            </div>
                            <button class="edit-button" onclick="openEditModal('${date}','${cls.time}','${cls.subject}','${cls.type}')">✏️</button>
                        </div>
                        <div class="attendance-buttons">
                            <button class="btn btn-present ${status === 'present' ? 'selected' : ''}" onclick="markAttendance('${date}','${cls.time}','${cls.subject}','present')">✅ Present</button>
                            <button class="btn btn-absent ${status === 'absent' ? 'selected' : ''}" onclick="markAttendance('${date}','${cls.time}','${cls.subject}','absent')">❌ Absent</button>
                            ${status ? `<button class="btn-undo" onclick="undoAttendance('${date}','${cls.time}','${cls.subject}')">↩️ Undo</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function markAttendance(date, time, subject, status) {
            const key = `${date}-${subject}-${time}`;
            attendanceData[key] = status;
            setStorageItem('attendanceData', attendanceData);
            
            // Success animation
            const button = event.target;
            animateElement(button, 'success-animation');
            showSuccessMessage(`Marked as ${status === 'present' ? 'Present' : 'Absent'} ✅`);
            
            updateDate();
        }

        function undoAttendance(date, time, subject) {
            const key = `${date}-${subject}-${time}`;
            delete attendanceData[key];
            setStorageItem('attendanceData', attendanceData);
            showSuccessMessage('Attendance record removed ↩️');
            updateDate();
        }

        function updateSummary() {
            const nonHolidayAttendance = {};
            Object.keys(attendanceData).forEach(key => {
                const date = key.split('-')[0];
                if (!holidays[date]) nonHolidayAttendance[key] = attendanceData[key];
            });
            
            const total = Object.keys(nonHolidayAttendance).length;
            const present = Object.values(nonHolidayAttendance).filter(s => s === 'present').length;
            const absent = Object.values(nonHolidayAttendance).filter(s => s === 'absent').length;
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
            const holidayCount = Object.keys(holidays).length;
            
            document.getElementById('total-classes').textContent = total;
            document.getElementById('present-count').textContent = present;
            document.getElementById('absent-count').textContent = absent;
            document.getElementById('holiday-count').textContent = holidayCount;
            
            const percentageEl = document.getElementById('overall-percentage');
            percentageEl.textContent = percentage + '%';
            percentageEl.className = 'percentage ' + (percentage >= 75 ? 'good' : percentage >= 50 ? 'warning' : 'danger');
            
            const breakdown = document.getElementById('subject-breakdown');
            let subjectHtml = '';
            Object.keys(subjects).forEach(code => {
                const subjectEntries = Object.keys(nonHolidayAttendance).filter(key => key.includes(code));
                const subjectTotal = subjectEntries.length;
                const subjectPresent = subjectEntries.filter(key => nonHolidayAttendance[key] === 'present').length;
                const subjectPercentage = subjectTotal > 0 ? Math.round((subjectPresent / subjectTotal) * 100) : 0;
                const colorClass = subjectPercentage >= 75 ? 'good' : subjectPercentage >= 50 ? 'warning' : 'danger';
                
                if (subjectTotal > 0) {
                    subjectHtml += `
                        <div style="margin: 12px 0; padding: 15px; border-left: 4px solid #1976d2; border-radius: 8px; background: rgba(25,118,210,0.05);">
                            <strong>${code}</strong><br>
                            <span class="${colorClass}" style="font-size:1.3em;">${subjectPercentage}%</span> 
                            <span style="color:#666;">(${subjectPresent}/${subjectTotal})</span>
                        </div>`;
                }
            });
            breakdown.innerHTML = subjectHtml || '<p style="color:#666;font-style:italic;">📝 No attendance data yet. Start marking attendance!</p>';
        }

        // Timetable Management Functions
        function displayTimetable() {
            const display = document.getElementById('timetable-display');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            display.innerHTML = days.map(day => {
                const dayClasses = schedule[day] || [];
                return `
                    <div class="day-schedule">
                        <div class="day-title">${day}</div>
                        ${dayClasses.length === 0 ? 
                            '<p style="color:#666;font-style:italic;">No classes scheduled</p>' :
                            dayClasses.map(cls => `
                                <div class="time-slot">
                                    <div class="time-slot-info">
                                        <strong>${cls.time}</strong><br>
                                        <span style="color:#1976d2;">${cls.subject}</span> - 
                                        <span class="class-type ${cls.type === 'L' ? 'lecture' : cls.type === 'P' ? 'practical' : 'tutorial'}">${cls.type === 'L' ? 'Lecture' : cls.type === 'P' ? 'Practical' : 'Tutorial'}</span>
                                    </div>
                                    <div class="time-slot-actions">
                                        <button class="btn-edit-time" onclick="openTimetableEditModal('${day}','${cls.time}','${cls.subject}','${cls.type}')">✏️</button>
                                        <button class="btn-remove" onclick="removeTimetableSlot('${day}','${cls.time}')">🗑️</button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                `;
            }).join('');
        }

        function addToTimetable() {
            const day = document.getElementById('timetable-day').value;
            const time = document.getElementById('timetable-time').value;
            const subject = document.getElementById('timetable-subject').value;
            const type = document.getElementById('timetable-type').value;
            
            if (!schedule[day]) schedule[day] = [];
            
            // Remove existing class at same time
            schedule[day] = schedule[day].filter(cls => cls.time !== time);
            
            // Add new class
            schedule[day].push({ time, subject, type });
            schedule[day].sort((a, b) => convertToMinutes(a.time) - convertToMinutes(b.time));
            
            setStorageItem('schedule', schedule);
            displayTimetable();
            showSuccessMessage(`Added ${subject} to ${day} timetable! 📚`);
        }

        function removeTimetableSlot(day, time) {
            if (!confirm(`Remove ${time} slot from ${day}?`)) return;
            
            if (schedule[day]) {
                schedule[day] = schedule[day].filter(cls => cls.time !== time);
                setStorageItem('schedule', schedule);
                displayTimetable();
                showSuccessMessage(`Removed ${time} slot from ${day} 🗑️`);
            }
        }

        function resetTimetable() {
            if (!confirm('Reset timetable to default? This will remove all your custom changes to the weekly schedule.')) return;
            
            schedule = JSON.parse(JSON.stringify(defaultSchedule));
            setStorageItem('schedule', schedule);
            displayTimetable();
            showSuccessMessage('Timetable reset to default! 🔄');
        }

        // Timetable Edit Modal Functions
        function openTimetableEditModal(day, time, subject, type) {
            const overlay = document.getElementById('overlay');
            const modal = document.getElementById('timetable-edit-modal');
            
            overlay.classList.remove('hidden');
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                overlay.classList.add('show');
                modal.classList.add('show');
            }, 10);
            
            document.getElementById('tt-edit-day').textContent = day;
            document.getElementById('tt-edit-time').textContent = time;
            document.getElementById('tt-edit-subject').value = subject;
            document.getElementById('tt-edit-type').value = type;
            
            modal.dataset.day = day;
            modal.dataset.time = time;
        }

        function closeTimetableEditModal() {
            const overlay = document.getElementById('overlay');
            const modal = document.getElementById('timetable-edit-modal');
            
            overlay.classList.remove('show');
            modal.classList.remove('show');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                modal.classList.add('hidden');
            }, 300);
        }

        function saveTimetableEdit() {
            const modal = document.getElementById('timetable-edit-modal');
            const day = modal.dataset.day;
            const oldTime = modal.dataset.time;
            const subject = document.getElementById('tt-edit-subject').value;
            const type = document.getElementById('tt-edit-type').value;
            
            if (schedule[day]) {
                const classIndex = schedule[day].findIndex(cls => cls.time === oldTime);
                if (classIndex !== -1) {
                    schedule[day][classIndex] = { time: oldTime, subject, type };
                    setStorageItem('schedule', schedule);
                    displayTimetable();
                    showSuccessMessage('Timetable updated! 💾');
                }
            }
            
            closeTimetableEditModal();
        }

        // Holiday functions
        function addHoliday() {
            const date = document.getElementById('holiday-date').value;
            const name = document.getElementById('holiday-name').value || 'Holiday';
            
            if (!date) { 
                alert('Please select a date'); 
                return; 
            }
            
            holidays[date] = name;
            setStorageItem('holidays', holidays);
            
            document.getElementById('holiday-date').value = '';
            document.getElementById('holiday-name').value = '';
            
            displayHolidays();
            showSuccessMessage(`Holiday "${name}" added! 🎉`);
        }

        function removeHoliday(date) {
            const holidayName = holidays[date];
            delete holidays[date];
            setStorageItem('holidays', holidays);
            displayHolidays();
            showSuccessMessage(`Holiday "${holidayName}" removed 🗑️`);
        }

        function displayHolidays() {
            const display = document.getElementById('holidays-display');
            const holidayDates = Object.keys(holidays).sort();
            
            if (holidayDates.length === 0) { 
                display.innerHTML = '<p style="color:#666;font-style:italic;">🗓️ No holidays marked yet</p>'; 
                return; 
            }
            
            display.innerHTML = holidayDates.map((date, index) => {
                const dayName = getDayName(date);
                return `
                    <div class="holiday-item" style="animation-delay: ${index * 0.1}s;">
                        <div class="item-content">
                            <strong style="color:#1976d2;">${holidays[date]}</strong><br>
                            <span style="color:#666;">${date} (${dayName})</span>
                        </div>
                        <div class="item-actions">
                            <button class="btn-remove" onclick="removeHoliday('${date}')">🗑️ Remove</button>
                        </div>
                    </div>`;
            }).join('');
        }

        // Export functions
        function generateAttendanceReport() {
            const nonHolidayAttendance = {};
            Object.keys(attendanceData).forEach(key => {
                const date = key.split('-')[0];
                if (!holidays[date]) nonHolidayAttendance[key] = attendanceData[key];
            });
            
            const total = Object.keys(nonHolidayAttendance).length;
            const present = Object.values(nonHolidayAttendance).filter(s => s === 'present').length;
            const absent = Object.values(nonHolidayAttendance).filter(s => s === 'absent').length;
            const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
            
            let report = `ATTENDANCE REPORT\n================================\nNational Diploma in Technology - Moratuwa\nGenerated on: ${new Date().toLocaleDateString()}\n\nOVERALL STATISTICS\n------------------\nTotal Classes (excluding holidays): ${total}\nPresent: ${present}\nAbsent: ${absent}\nOverall Attendance: ${percentage}%\nHolidays Excluded: ${Object.keys(holidays).length}\n\nSUBJECT-WISE BREAKDOWN\n----------------------\n`;
            
            Object.keys(subjects).forEach(code => {
                const subjectEntries = Object.keys(nonHolidayAttendance).filter(key => key.includes(code));
                const subjectTotal = subjectEntries.length;
                const subjectPresent = subjectEntries.filter(key => nonHolidayAttendance[key] === 'present').length;
                const subjectPercentage = subjectTotal > 0 ? Math.round((subjectPresent / subjectTotal) * 100) : 0;
                
                if (subjectTotal > 0) {
                    report += `${code}: ${subjectPercentage}% (${subjectPresent}/${subjectTotal}) - ${subjects[code]}\n`;
                }
            });
            
            if (Object.keys(holidays).length > 0) {
                report += `\nHOLIDAYS EXCLUDED\n-----------------\n`;
                Object.keys(holidays).sort().forEach(date => { 
                    report += `${date}: ${holidays[date]}\n`; 
                });
            }
            
            return report;
        }

        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const report = generateAttendanceReport();
                const lines = report.split('\n');
                let y = 20;
                const lineHeight = 8;
                const pageHeight = doc.internal.pageSize.height - 30;
                
                // Add title styling
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                
                lines.forEach((line, index) => {
                    if (y > pageHeight) { 
                        doc.addPage(); 
                        y = 20; 
                    }
                    
                    if (index === 0) {
                        doc.setFontSize(16);
                        doc.setFont(undefined, 'bold');
                    } else if (line.includes('STATISTICS') || line.includes('BREAKDOWN') || line.includes('HOLIDAYS')) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                    } else {
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                    }
                    
                    doc.text(line, 15, y);
                    y += lineHeight;
                });
                
                doc.save('attendance-report.pdf');
                showSuccessMessage('PDF report exported! 📄');
            } catch (e) {
                alert('PDF export failed. Please try Export as Text instead.');
            }
        }

        function exportToText() {
            const report = generateAttendanceReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'attendance-report.txt'; 
            a.click(); 
            URL.revokeObjectURL(url);
            showSuccessMessage('Text report exported! 📝');
        }

        function copyToClipboard() {
            const report = generateAttendanceReport();
            if (navigator.clipboard) {
                navigator.clipboard.writeText(report).then(() => { 
                    showSuccessMessage('Report copied to clipboard! 📋');
                }).catch(() => { 
                    fallbackCopyTextToClipboard(report);
                });
            } else {
                fallbackCopyTextToClipboard(report);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showSuccessMessage('Report copied to clipboard! 📋');
            } catch (err) {
                console.error('Fallback: Could not copy text: ', err);
                alert('Could not copy to clipboard. Please try the export options instead.');
            }
            
            document.body.removeChild(textArea);
        }

        // Data management
        function clearAllData() {
            if (!confirm('⚠️ Clear all attendance data? This action cannot be undone!')) return;
            
            try {
                localStorage.removeItem('attendanceData'); 
                localStorage.removeItem('holidays'); 
                localStorage.removeItem('customSchedule'); 
            } catch (e) {
                console.warn('Could not clear localStorage');
            }
            
            attendanceData = {}; 
            holidays = {}; 
            customSchedule = {}; 
            
            updateDate(); 
            displayHolidays(); 
            displayCustomSchedule();
            showSuccessMessage('All data cleared! 🗑️');
        }

        function exportData() {
            const data = { 
                attendanceData, 
                holidays, 
                customSchedule, 
                schedule,
                exportDate: new Date().toISOString() 
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = 'attendance-backup.json'; 
            a.click(); 
            URL.revokeObjectURL(url);
            showSuccessMessage('Data backup created! 💾');
        }

        function importData(event) {
            const file = event.target.files[0]; 
            if (!file) return; 
            
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                try { 
                    const data = JSON.parse(e.target.result); 
                    
                    if (data.attendanceData) attendanceData = data.attendanceData; 
                    if (data.holidays) holidays = data.holidays; 
                    if (data.customSchedule) customSchedule = data.customSchedule; 
                    if (data.schedule) schedule = data.schedule;
                    
                    setStorageItem('attendanceData', attendanceData); 
                    setStorageItem('holidays', holidays); 
                    setStorageItem('customSchedule', customSchedule); 
                    setStorageItem('schedule', schedule);
                    
                    updateDate(); 
                    displayHolidays(); 
                    displayCustomSchedule(); 
                    displayTimetable();
                    
                    showSuccessMessage('Data imported successfully! 📂');
                } catch (err) { 
                    alert('❌ Invalid backup file. Please select a valid JSON backup.'); 
                } 
            }; 
            reader.readAsText(file);
        }

        // Custom schedule functions
        function addSlotToDate() {
            const date = document.getElementById('date-picker').value;
            const time = document.getElementById('add-time').value;
            const subject = document.getElementById('add-subject').value;
            const type = document.getElementById('add-type').value;
            
            if (!date) { 
                alert('Please select a date first'); 
                return; 
            }
            
            if (!customSchedule[date]) customSchedule[date] = [];
            
            // Remove existing class at same time
            customSchedule[date] = customSchedule[date].filter(cls => cls.time !== time);
            customSchedule[date].push({ time, subject, type });
            customSchedule[date].sort((a, b) => convertToMinutes(a.time) - convertToMinutes(b.time));
            
            setStorageItem('customSchedule', customSchedule);
            displayCustomSchedule(); 
            updateDate();
            showSuccessMessage(`Class added for ${date}! 📝`);
        }

        function displayCustomSchedule() {
            const display = document.getElementById('custom-schedule-display');
            const customDates = Object.keys(customSchedule).sort();
            
            if (customDates.length === 0) { 
                display.innerHTML = '<p style="color:#666;font-style:italic;">📅 No custom schedule changes yet</p>'; 
                return; 
            }
            
            display.innerHTML = `
                <h5 style="color:#1976d2;margin-bottom:15px;">📅 Custom Schedule Changes:</h5>
                ${customDates.map((date, index) => {
                    const dayName = getDayName(date);
                    return `
                        <div class="timetable-item" style="animation-delay: ${index * 0.1}s;">
                            <div class="item-content">
                                <strong style="color:#1976d2;">${date} (${dayName})</strong><br>
                                ${customSchedule[date].map(cls => `
                                    <span style="color:#666;">• ${cls.time}: ${cls.subject} (${cls.type === 'L' ? 'Lecture' : cls.type === 'P' ? 'Practical' : 'Tutorial'})</span>
                                `).join('<br>')}
                            </div>
                            <div class="item-actions">
                                <button class="btn-remove" onclick="removeCustomSchedule('${date}')">🗑️ Remove</button>
                            </div>
                        </div>`;
                }).join('')}
            `;
        }

        function removeCustomSchedule(date) { 
            if (!confirm(`Remove all custom classes for ${date}?`)) return;
            
            delete customSchedule[date]; 
            setStorageItem('customSchedule', customSchedule); 
            displayCustomSchedule(); 
            updateDate(); 
            showSuccessMessage(`Custom schedule for ${date} removed! 🗑️`);
        }

        // Edit modal functions
        function openEditModal(date, time, subject, type) {
            const overlay = document.getElementById('overlay');
            const modal = document.getElementById('edit-modal');
            
            overlay.classList.remove('hidden');
            modal.classList.remove('hidden');
            
            setTimeout(() => {
                overlay.classList.add('show');
                modal.classList.add('show');
            }, 10);
            
            document.getElementById('edit-modal-date-text').textContent = date;
            document.getElementById('edit-modal-time').textContent = time;
            document.getElementById('edit-modal-subject').value = subject || Object.keys(subjects)[0];
            document.getElementById('edit-modal-type').value = type || 'L';
            
            modal.dataset.date = date; 
            modal.dataset.time = time;
        }

        function closeEditModal() { 
            const overlay = document.getElementById('overlay');
            const modal = document.getElementById('edit-modal');
            
            overlay.classList.remove('show');
            modal.classList.remove('show');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                modal.classList.add('hidden');
            }, 300);
        }

        function saveEditModal() {
            const modal = document.getElementById('edit-modal');
            const date = modal.dataset.date; 
            const time = modal.dataset.time;
            const subject = document.getElementById('edit-modal-subject').value; 
            const type = document.getElementById('edit-modal-type').value;
            
            if (!customSchedule[date]) customSchedule[date] = [];
            
            // Remove any class at same time
            customSchedule[date] = customSchedule[date].filter(c => c.time !== time);
            customSchedule[date].push({ time, subject, type });
            customSchedule[date].sort((a, b) => convertToMinutes(a.time) - convertToMinutes(b.time));
            
            setStorageItem('customSchedule', customSchedule);
            closeEditModal(); 
            displayCustomSchedule(); 
            updateDate();
            showSuccessMessage('Class updated! ✏️');
        }

        // Enhanced modal management for mobile
        function closeAllModals() {
            closeEditModal();
            closeTimetableEditModal();
        }

        // Add click outside to close modals
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('overlay')) {
                closeAllModals();
            }
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllModals();
            }
        });

        // Touch event handling for better mobile experience
        let touchStartY = 0;
        document.addEventListener('touchstart', function(e) {
            touchStartY = e.touches[0].clientY;
        });

        document.addEventListener('touchmove', function(e) {
            // Prevent rubber band scrolling on iOS when at top/bottom
            const modal = document.querySelector('.modal:not(.hidden)');
            if (modal) {
                const modalRect = modal.getBoundingClientRect();
                const touchY = e.touches[0].clientY;
                
                if (touchY < modalRect.top || touchY > modalRect.bottom) {
                    e.preventDefault();
                }
            }
        });

        // Prevent zoom on double tap for buttons
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Add smooth transitions when switching views
        function smoothTransition(callback) {
            const activeContent = document.querySelector('.content:not(.hidden)');
            if (activeContent) {
                activeContent.style.opacity = '0.5';
                setTimeout(() => {
                    callback();
                    activeContent.style.opacity = '1';
                }, 150);
            }
        }

        // Enhanced viewport handling for mobile
        function handleViewportChanges() {
            // Adjust for mobile keyboards
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', handleViewportChanges);
        window.addEventListener('orientationchange', function() {
            setTimeout(handleViewportChanges, 500);
        });

        // Initialize viewport
        handleViewportChanges();

        // Add loading states for better UX
        function showLoading(element) {
            element.classList.add('loading');
        }

        function hideLoading(element) {
            element.classList.remove('loading');
        }

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Application error:', e);
            showSuccessMessage('⚠️ Something went wrong. Please try again.');
        });

        // Service worker registration for offline functionality (if needed)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Service worker can be registered here for offline support
                console.log('App ready for offline enhancements');
            });
        }
    </script>
</body>
</html>
